name: Security Audit

on:
  push:
    branches: [ main, develop, master ]
  pull_request:
    branches: [ main, develop, master ]
  schedule:
    # æ¯æ—¥åˆå‰0æ™‚ï¼ˆUTCï¼‰ã«å®Ÿè¡Œ = æ—¥æœ¬æ™‚é–“åˆå‰9æ™‚
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  audit:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run npm audit
      id: audit
      run: |
        echo "## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»çµæœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # moderate ãƒ¬ãƒ™ãƒ«ä»¥ä¸Šã®è„†å¼±æ€§ã‚’ãƒã‚§ãƒƒã‚¯
        if npm audit --audit-level=moderate; then
          echo "âœ… è„†å¼±æ€§ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          echo "status=success" >> $GITHUB_OUTPUT
        else
          echo "âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          echo "status=failure" >> $GITHUB_OUTPUT
        fi
    
    - name: Generate detailed audit report
      if: always()
      run: |
        # JSONå½¢å¼ã§è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
        npm audit --json > audit-report.json
        
        # äººé–“ãŒèª­ã¿ã‚„ã™ã„å½¢å¼ã§ã‚‚å‡ºåŠ›
        echo "## è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        npm audit >> $GITHUB_STEP_SUMMARY || true
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
    
    - name: Check package versions
      run: |
        echo "## ğŸ“¦ ä¸»è¦ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒ¼ã‚¸ãƒ§ãƒ³" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | çŠ¶æ…‹ |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|----------|------|" >> $GITHUB_STEP_SUMMARY
        
        # Next.js - Only 16.0.10+ is considered safe
        NEXT_VERSION=$(npm list next --depth=0 2>/dev/null | grep next@ | sed 's/.*next@//' || echo "æœªæ¤œå‡º")
        if [[ "$NEXT_VERSION" == "æœªæ¤œå‡º" ]]; then
          echo "| Next.js | $NEXT_VERSION | âš ï¸ è¦ç¢ºèª |" >> $GITHUB_STEP_SUMMARY
        else
          MAJOR=$(echo "$NEXT_VERSION" | cut -d. -f1)
          MINOR=$(echo "$NEXT_VERSION" | cut -d. -f2)
          PATCH=$(echo "$NEXT_VERSION" | cut -d. -f3 | cut -d- -f1)
          if [[ "$MAJOR" -gt 16 ]] || { [[ "$MAJOR" -eq 16 ]] && { [[ "$MINOR" -gt 0 ]] || { [[ "$MINOR" -eq 0 ]] && [[ "$PATCH" -ge 10 ]]; }; }; }; then
            echo "| Next.js | $NEXT_VERSION | âœ… å®‰å…¨ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Next.js | $NEXT_VERSION | âš ï¸ è¦ç¢ºèª (16.0.10+ãŒå¿…è¦) |" >> $GITHUB_STEP_SUMMARY
          fi
        fi
        
        # ESLint
        ESLINT_VERSION=$(npm list eslint --depth=0 2>/dev/null | grep eslint@ | sed 's/.*eslint@//' || echo "æœªæ¤œå‡º")
        if [[ "$ESLINT_VERSION" =~ ^9\. ]]; then
          echo "| ESLint | $ESLINT_VERSION | âœ… å®‰å…¨ |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| ESLint | $ESLINT_VERSION | âš ï¸ è¦ç¢ºèª |" >> $GITHUB_STEP_SUMMARY
        fi
        
        # React
        REACT_VERSION=$(npm list react --depth=0 2>/dev/null | grep react@ | sed 's/.*react@//' || echo "æœªæ¤œå‡º")
        echo "| React | $REACT_VERSION | âœ… å®‰å…¨ |" >> $GITHUB_STEP_SUMMARY
    
    - name: Upload audit report
      if: always()
      uses: actions/upload-artifact@v6
      with:
        name: security-audit-report-${{ github.run_id }}
        path: audit-report.json
        retention-days: 90
    
    - name: Fail on vulnerabilities
      if: steps.audit.outputs.status == 'failure'
      run: |
        echo "::error::ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚è©³ç´°ã¯audit-report.jsonã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
        echo "SECURITY_REQUIREMENTS.md ã‚’å‚ç…§ã—ã¦ã€ç›´ã¡ã«å¯¾å¿œã—ã¦ãã ã•ã„ã€‚"
        exit 1
    
    - name: Comment on PR (if applicable)
      if: github.event_name == 'pull_request' && steps.audit.outputs.status == 'failure'
      uses: actions/github-script@v8
      env:
        SERVER_URL: ${{ github.server_url }}
        REPOSITORY: ${{ github.repository }}
        RUN_ID: ${{ github.run_id }}
      with:
        script: |
          const serverUrl = process.env.SERVER_URL;
          const repository = process.env.REPOSITORY;
          const runId = process.env.RUN_ID;
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `âš ï¸ **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ã§è„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ**\n\nè©³ç´°ã¯[Actionsãƒ­ã‚°](${serverUrl}/${repository}/actions/runs/${runId})ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n\n\`docs/SECURITY_REQUIREMENTS.md\` ã‚’å‚ç…§ã—ã¦å¯¾å¿œã—ã¦ãã ã•ã„ã€‚`
          })
